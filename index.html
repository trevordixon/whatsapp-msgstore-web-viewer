<!doctype html>
<html>
    <head>
        <title>WhatsApp msgstore.db Viewer</title>
        <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
        <style>
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Helvetica, Arial, sans-serif;
                margin: 0;
            }
            #app {
                display: flex;
                height: 100vh;
            }
            .sidebar {
                width: 30%;
                border-right: 1px solid #ccc;
                overflow-y: auto;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }
            .main {
                width: 70%;
                overflow-y: auto;
                padding: 10px;
                height: 100vh;
                display: flex;
                flex-direction: column-reverse;
            }
            .input-container {
                padding: 10px;
                border-bottom: 1px solid #ccc;
            }
            .controls-container {
                padding: 10px;
                border-bottom: 1px solid #ccc;
                display: flex;
                gap: 15px;
            }
            .controls-container > div {
                display: flex;
                flex-direction: column;
            }
            .controls-container label {
                font-size: 0.8em;
                color: #555;
                margin-bottom: 4px;
            }
            .controls-container input {
                width: 80px;
            }
            .conversation-list {
                flex-grow: 1;
                overflow-y: auto;
            }
            .conversation {
                padding: 10px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .conversation:hover,
            .conversation.selected {
                background-color: #f0f0f0;
            }
            .message-list {
                background-color: #fafafa;
                overflow-y: auto;
            }
            .message {
                margin: 0 8px 8px 8px;
                padding: 5px 10px;
                border-radius: 15px;
                max-width: 70%;
                line-height: 1.4;
                word-wrap: break-word;
                white-space: pre-line;
                border: 1px solid #ccc;
            }
            .message blockquote {
                margin: 4px 0;
                padding-left: 8px;
                border-left: 2px solid #ccc;
                font-size: 90%;
                color: #666;
            }
            .message time {
                display: block;
                font-size: 0.8em;
                color: #666;
                margin-top: 6px;
                text-align: right;
            }
            .from-me {
                background-color: #dcf8c6;
                align-self: flex-end;
            }
            .from-them {
                background-color: #fff;
                align-self: flex-start;
                border: 1px solid #eee;
            }
            .message-container {
                display: flex;
                flex-direction: column;
            }
            .placeholder {
                font-style: italic;
                color: #888;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <div class="sidebar">
                <div class="input-container">
                    <label for="db-file">Open msgstore.db: </label>
                    <input type="file" id="db-file" @change="loadFile" />
                </div>

                <!-- START: New Controls Section -->
                <div class="controls-container">
                    <div>
                        <label for="max-chats">Max Chats</label>
                        <input
                            type="number"
                            id="max-chats"
                            v-model.number="maxChats"
                            min="1"
                        />
                    </div>
                    <div>
                        <label for="max-messages">Max Messages</label>
                        <input
                            type="number"
                            id="max-messages"
                            v-model.number="maxMessages"
                            min="1"
                        />
                    </div>
                </div>
                <!-- END: New Controls Section -->

                <div class="conversation-list">
                    <div
                        v-for="conversation in conversations"
                        :key="conversation._id"
                        @click="selectConversation(conversation)"
                        class="conversation"
                        :class="{ selected: selectedConversation && selectedConversation._id === conversation._id }"
                    >
                        {{ conversation.subject || conversation.jid }}
                    </div>
                </div>
            </div>
            <div class="main">
                <div class="message-list">
                    <div class="message-container">
                        <div
                            v-for="(message, index) in messages"
                            :key="index"
                            class="message"
                            :class="message.from_me ? 'from-me' : 'from-them'"
                        >
                            <blockquote v-if="message.quoted" class="quoted">
                                {{ message.quoted }}
                            </blockquote>
                            <div v-if="message.data">{{ message.data }}</div>
                            <div v-else class="placeholder">
                                [Media or Empty Message]
                            </div>
                            <time>
                                {{ message.timestamp.toLocaleDateString() }} {{
                                message.timestamp.getHours() }}:{{
                                String(message.timestamp.getMinutes()).padStart(2,
                                '0') }}
                            </time>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const { createApp } = Vue;

            createApp({
                data() {
                    return {
                        db: null,
                        conversations: [],
                        selectedConversation: null,
                        messages: [],
                        // START: New data properties for limits
                        maxChats: 1000,
                        maxMessages: 10000,
                        // END: New data properties
                    };
                },
                // START: New watcher to make inputs reactive
                watch: {
                    maxChats(newLimit, oldLimit) {
                        // Re-load conversations if the database is loaded and the limit changes
                        if (this.db && newLimit !== oldLimit) {
                            console.log(
                                `Chat limit changed to: ${newLimit}. Reloading conversations.`,
                            );
                            this.loadConversations();
                        }
                    },
                    maxMessages(newLimit, oldLimit) {
                        // Re-load messages for the selected chat if the limit changes
                        if (
                            this.db &&
                            this.selectedConversation &&
                            newLimit !== oldLimit
                        ) {
                            console.log(
                                `Message limit changed to: ${newLimit}. Reloading messages.`,
                            );
                            this.selectConversation(this.selectedConversation);
                        }
                    },
                },
                // END: New watcher
                methods: {
                    async loadFile(event) {
                        const file = event.target.files[0];
                        if (!file) return;

                        try {
                            const arrayBuffer = await file.arrayBuffer();
                            const SQL = await initSqlJs({
                                locateFile: (file) =>
                                    `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`,
                            });
                            this.db = new SQL.Database(
                                new Uint8Array(arrayBuffer),
                            );
                            this.loadConversations();
                        } catch (e) {
                            console.error(e);
                            alert(
                                "Error loading database file. Please ensure it is a valid, unencrypted msgstore.db file.",
                            );
                        }
                    },
                    loadConversations() {
                        if (!this.db) return;
                        try {
                            // **MODIFIED:** Using reactive maxChats property in the LIMIT clause
                            const query = `
                              SELECT
                                chat._id,
                                jid.user,
                                chat.subject
                              FROM chat
                              JOIN jid ON chat.jid_row_id = jid._id
                              ORDER BY chat.sort_timestamp DESC
                              LIMIT ${this.maxChats}
                            `;
                            const res = this.db.exec(query);
                            if (res.length > 0 && res[0].values) {
                                this.conversations = res[0].values.map(
                                    (row) => ({
                                        _id: row[0],
                                        jid: row[1],
                                        subject: row[2],
                                    }),
                                );
                            } else {
                                this.conversations = [];
                            }
                        } catch (e) {
                            console.error(e);
                            alert(
                                "Could not read conversations. The database schema might be different. " +
                                    e.message,
                            );
                        }
                    },
                    selectConversation(conversation) {
                        if (!this.db) return;
                        this.selectedConversation = conversation;
                        try {
                            // **MODIFIED:** Using reactive maxMessages property in the LIMIT clause
                            const query = `
                              SELECT
                                message.from_me,
                                message.text_data,
                                message.timestamp,
                                (SELECT text_data FROM message_quoted WHERE message_quoted.message_row_id = message._id) AS quoted_text
                              FROM
                                message
                              WHERE
                                message.chat_row_id = ${conversation._id}
                              ORDER BY
                                message.sort_id DESC
                              LIMIT
                                ${this.maxMessages}
                            `;
                            const res = this.db.exec(query);

                            if (res.length > 0 && res[0].values) {
                                this.messages = res[0].values
                                    .map((row) => ({
                                        from_me: row[0] === 1,
                                        data: row[1],
                                        timestamp: new Date(row[2]),
                                        quoted: row[3],
                                    }))
                                    .reverse();
                            } else {
                                this.messages = [];
                            }
                        } catch (e) {
                            console.error(e);
                            alert(
                                "Could not load messages for this conversation.",
                            );
                        }
                    },
                },
            }).mount("#app");
        </script>
    </body>
</html>
